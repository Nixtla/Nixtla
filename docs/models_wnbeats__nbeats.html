---

title: Title


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/models_wnbeats__nbeats.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/models_wnbeats__nbeats.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="init_weights" class="doc_header"><code>init_weights</code><a href="https://github.com/Grupo-Abraxas/nixtla/tree/master/nixtla/models/wnbeats/nbeats.py#L25" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>init_weights</code>(<strong><code>module</code></strong>, <strong><code>initialization</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Nbeats" class="doc_header"><code>class</code> <code>Nbeats</code><a href="https://github.com/Grupo-Abraxas/nixtla/tree/master/nixtla/models/wnbeats/nbeats.py#L42" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Nbeats</code>(<strong><code>n_x_t</code></strong>, <strong><code>n_x_s</code></strong>, <strong><code>t_cols</code></strong>, <strong><code>include_var_dict</code></strong>, <strong><code>input_size_multiplier</code></strong>, <strong><code>output_size</code></strong>, <strong><code>shared_weights</code></strong>, <strong><code>activation</code></strong>, <strong><code>initialization</code></strong>, <strong><code>stack_types</code></strong>, <strong><code>n_blocks</code></strong>, <strong><code>n_theta_hidden_list</code></strong>, <strong><code>n_xbasis_layers</code></strong>, <strong><code>n_xbasis_channels</code></strong>, <strong><code>n_s_hidden</code></strong>, <strong><code>scaler</code></strong>, <strong><code>batch_normalization</code></strong>, <strong><code>learning_rate</code></strong>, <strong><code>lr_decay</code></strong>, <strong><code>n_lr_decay_steps</code></strong>, <strong><code>dropout_prob_theta</code></strong>, <strong><code>dropout_prob_xbasis</code></strong>, <strong><code>lambda_l1_theta</code></strong>, <strong><code>lambda_l1_input</code></strong>, <strong><code>lambda_l2_xbasis</code></strong>, <strong><code>max_epochs</code></strong>, <strong><code>early_stopping</code></strong>, <strong><code>loss</code></strong>, <strong><code>frequency</code></strong>, <strong><code>seasonality</code></strong>, <strong><code>random_seed</code></strong>, <strong><code>device</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Future documentation</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">print_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="mi">120</span><span class="o">*</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:&lt;40}</span><span class="s1"> </span><span class="si">{:&lt;40}</span><span class="s1"> </span><span class="si">{:&lt;40}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Weights&#39;</span><span class="p">,</span> <span class="s1">&#39;Parameter shape&#39;</span><span class="p">,</span> <span class="s1">&#39;Number of parameters&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="mi">120</span><span class="o">*</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">total_params</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">model_param_name</span><span class="p">,</span> <span class="n">model_param_value</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:&lt;50}</span><span class="s1"> </span><span class="si">{:&lt;40}</span><span class="s1"> </span><span class="si">{:&lt;40}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_param_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_param_value</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_param_value</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
        <span class="n">total_params</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_param_value</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">120</span><span class="o">*</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total parameters: </span><span class="si">{</span><span class="n">total_params</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="mi">120</span><span class="o">*</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># import pandas as pd</span>
<span class="c1"># from torch.utils.data import Dataset, DataLoader</span>

<span class="c1"># class TimeSeriesDataset(Dataset):</span>
<span class="c1">#     def __init__(self, X, Y=None):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         &quot;&quot;&quot;        </span>
<span class="c1">#         self.insample_y  = X[:, (7*0)*24:(7*1)*24]</span>

<span class="c1">#         insample_x1 = X[:, (7*1)*24:(7*2)*24]</span>
<span class="c1">#         insample_x2 = X[:, (7*2)*24:(7*3)*24]</span>
<span class="c1">#         insample_x3 = X[:, (7*3)*24:(7*4)*24]</span>
        
<span class="c1">#         self.insample_x  = np.concatenate([insample_x1[:,None,:], </span>
<span class="c1">#                                            insample_x2[:,None,:], </span>
<span class="c1">#                                            insample_x3[:,None,:]], axis=1)</span>

<span class="c1">#         self.insample_mask = np.ones(shape=self.insample_y.shape)</span>
        
<span class="c1">#         outsample_x1 = X[:, (7*4+0)*24:(7*4+1)*24]</span>
<span class="c1">#         outsample_x2 = X[:, (7*4+1)*24:(7*4+2)*24]</span>
<span class="c1">#         outsample_x3 = X[:, (7*4+2)*24:(7*4+3)*24]</span>
        
<span class="c1">#         self.outsample_x  = np.concatenate([outsample_x1[:,None,:], </span>
<span class="c1">#                                             outsample_x2[:,None,:], </span>
<span class="c1">#                                             outsample_x3[:,None,:]], axis=1)</span>

<span class="c1">#         self.outsample_y = Y</span>
<span class="c1">#         self.outsample_mask = np.ones(shape=(self.outsample_x.shape[0], self.outsample_x.shape[2]))</span>

<span class="c1">#         assert np.sum(np.isnan(X))&lt;1.0, \</span>
<span class="c1">#             f&#39; X has {np.sum(np.isnan(X))} nan values&#39;</span>

<span class="c1">#         if Y is not None:</span>
<span class="c1">#             assert np.sum(np.isnan(Y))&lt;1.0, \</span>
<span class="c1">#                 f&#39;Y has {np.sum(np.isnan(Y))} nan values&#39;</span>

<span class="c1">#     def __len__(self):</span>
<span class="c1">#         return len(self.outsample_x)</span>

<span class="c1">#     def __getitem__(self, idx):        </span>
<span class="c1">#         # insample y</span>
<span class="c1">#         insample_y     = self.insample_y[idx, :]</span>

<span class="c1">#         # insample and outsample x</span>
<span class="c1">#         insample_x     = self.insample_x[idx, :, :]</span>
<span class="c1">#         outsample_x    = self.outsample_x[idx, :, :]</span>
        
<span class="c1">#         # train masks</span>
<span class="c1">#         insample_mask  = self.insample_mask[idx, :]</span>
<span class="c1">#         outsample_mask = self.outsample_mask[idx, :]</span>

<span class="c1">#         # outsample y</span>
<span class="c1">#         if self.outsample_y is not None:</span>
<span class="c1">#             outsample_y    = self.outsample_y[idx, :]</span>
<span class="c1">#         else:</span>
<span class="c1">#             outsample_y    = []</span>

<span class="c1">#         batch = {&#39;s_matrix&#39;: [],</span>
<span class="c1">#                  &#39;insample_y&#39;: insample_y, &#39;insample_x&#39;:insample_x, &#39;insample_mask&#39;:insample_mask,</span>
<span class="c1">#                  &#39;outsample_y&#39;: outsample_y, &#39;outsample_x&#39;:outsample_x, &#39;outsample_mask&#39;:outsample_mask}</span>
<span class="c1">#         return batch</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># import numpy as np</span>
<span class="c1"># import pandas as pd</span>
<span class="c1"># import random</span>
<span class="c1"># import torch as t</span>
<span class="c1"># import copy</span>
<span class="c1"># from fastcore.foundation import patch</span>
<span class="c1"># from nixtla.data.scalers import scaling</span>
<span class="c1"># # from nixtla.data.ontsdataset import TimeSeriesDataset</span>
<span class="c1"># # from nixtla.data.ontsloader_fast import TimeSeriesLoader as TimeSeriesLoaderFast</span>

<span class="c1"># np.random.seed(1)</span>
<span class="c1"># t.manual_seed(1)</span>

<span class="c1"># Xtrain = np.genfromtxt(&#39;../data/epf/Xtrain.csv&#39;)</span>
<span class="c1"># Ytrain = np.genfromtxt(&#39;../data/epf/Ytrain.csv&#39;)</span>

<span class="c1"># [Xtrain], _ = scaling(datasets=[Xtrain], normalize=&#39;Norm1&#39;)</span>
<span class="c1"># [Y_train], scaler = scaling(datasets=[Ytrain], normalize=&#39;Norm1&#39;)</span>

<span class="c1"># print(&#39;X: time series features, of shape (#series,#times,#features): \t&#39; + str(Xtrain.shape))</span>
<span class="c1"># print(&#39;Y: target series (in X), of shape (#series,#times): \t \t&#39; + str(Ytrain.shape))</span>
<span class="c1"># # print(&#39;S: static features, of shape (#series,#features): \t \t&#39; + str(S.shape))</span>
<span class="c1"># #Y_insample_df.head()</span>
<span class="c1"># #Y_insample_df.tail()</span>
<span class="c1"># print(&quot;\n\n&quot;)</span>

<span class="c1"># train_dataset = TimeSeriesDataset(X=Xtrain, Y=Ytrain)</span>
<span class="c1"># train_loader = DataLoader(train_dataset, batch_size=4,</span>
<span class="c1">#                           shuffle=True, num_workers=0)</span>

<span class="c1"># val_dataset = TimeSeriesDataset(X=Xtrain, Y=Ytrain)</span>
<span class="c1"># val_loader = DataLoader(val_dataset, batch_size=4,</span>
<span class="c1">#                         shuffle=True, num_workers=0)                        </span>

<span class="c1"># start = time.time()</span>
<span class="c1"># dataloader = iter(train_loader)</span>
<span class="c1"># batch = next(dataloader)</span>
<span class="c1"># insample_y = batch[&#39;insample_y&#39;]</span>
<span class="c1"># insample_x = batch[&#39;insample_x&#39;]</span>
<span class="c1"># insample_mask = batch[&#39;insample_mask&#39;]</span>
<span class="c1"># outsample_x = batch[&#39;outsample_x&#39;]</span>
<span class="c1"># outsample_y = batch[&#39;outsample_y&#39;]</span>
<span class="c1"># outsample_mask = batch[&#39;outsample_mask&#39;]</span>

<span class="c1"># print(&quot;DataloaderFast batch time:&quot;, time.time()-start)</span>
<span class="c1"># print(&quot;insample_y.shape&quot;, insample_y.shape)</span>
<span class="c1"># print(&quot;insample_x.shape&quot;, insample_x.shape)</span>
<span class="c1"># print(&quot;insample_mask.shape&quot;, insample_mask.shape)</span>

<span class="c1"># print(&quot;outsample_y.shape&quot;, outsample_y.shape)</span>
<span class="c1"># print(&quot;outsample_x.shape&quot;, outsample_x.shape)</span>
<span class="c1"># print(&quot;outsample_mask.shape&quot;, outsample_mask.shape)</span>

<span class="c1"># print(&quot;t.max(insample_y)&quot;, t.max(insample_y))</span>
<span class="c1"># print(&quot;t.max(outsample_y)&quot;, t.max(outsample_y * outsample_mask))</span>
<span class="c1"># print(&quot;\n\n&quot;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#                  n_x_s=0,</span>
<span class="c1">#                  t_cols=[&#39;y&#39;, &#39;Exogenous1&#39;, &#39;Exogenous2&#39;, &#39;week_day&#39;],</span>
<span class="c1">#                  include_var_dict={&#39;y&#39;: [-2, -8], </span>
<span class="c1">#                                    &#39;Exogenous1&#39;: [-2, -8],</span>
<span class="c1">#                                    &#39;Exogenous2&#39;: [-2, -8],</span>
<span class="c1">#                                    &#39;week_day&#39;: [-1]},</span>
<span class="c1">#                  input_size_multiplier=7,</span>
<span class="c1">#                  output_size=24,</span>
<span class="c1">#                  shared_weights=False,</span>
<span class="c1">#                  activation=&#39;relu&#39;,</span>
<span class="c1">#                  initialization=&#39;lecun_normal&#39;,                </span>
<span class="c1">#                  stack_types=[&#39;exogenous_wavenet&#39;]+3*[&#39;identity&#39;],</span>
<span class="c1">#                  n_blocks=4*[1],</span>
<span class="c1">#                  n_theta_hidden_list=4*[[256,256]],</span>
<span class="c1">#                  n_xbasis_layers=4,</span>
<span class="c1">#                  n_xbasis_channels=2,</span>
<span class="c1">#                  n_s_hidden=10,</span>
<span class="c1">#                  scaler=scaler, # It is updated in recalibrate_and_forecast_next_day method</span>
<span class="c1">#                  batch_normalization=False,</span>
<span class="c1">#                  learning_rate=0.001,</span>
<span class="c1">#                  lr_decay=0.5,</span>
<span class="c1">#                  n_lr_decay_steps=3,</span>
<span class="c1">#                  dropout_prob_theta=0.1,</span>
<span class="c1">#                  dropout_prob_xbasis=0.1,</span>
<span class="c1">#                  lambda_l1_input=0.01,</span>
<span class="c1">#                  lambda_l1_theta=0.01,</span>
<span class="c1">#                  lambda_l2_xbasis=0.01,</span>
<span class="c1">#                  max_epochs=100,</span>
<span class="c1">#                  early_stopping=20,</span>
<span class="c1">#                  loss=&#39;MAE&#39;,</span>
<span class="c1">#                  frequency=24,</span>
<span class="c1">#                  seasonality=&#39;H&#39;,</span>
<span class="c1">#                  random_seed=1)</span>

<span class="c1"># nbeatsx.fit(train_ts_loader=train_loader, val_ts_loader=val_loader, max_epochs=20, verbose=True, eval_steps=1)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

